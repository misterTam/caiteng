<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF 转图片工具</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    .drop{border:2px dashed var(--border);padding:20px;border-radius:12px;text-align:center}
    .thumbs{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:640px){.thumbs{grid-template-columns:1fr 1fr}}
    .thumb{border:1px solid var(--border);border-radius:10px;padding:8px}
  </style>
  <script src="https://cdn.staticfile.org/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
  <main class="container">
    <h1>PDF 转图片工具</h1>
    <p class="muted">在浏览器本地将 PDF 每一页导出为 PNG 图片，并生成 `manual-images/manifest.json`。</p>

    <div class="drop" id="drop">拖拽 PDF 到此处，或 <input type="file" id="file" accept="application/pdf" /></div>
    <div class="thumbs" id="thumbs"></div>
    <div class="row" style="gap:10px;margin-top:12px">
      <button class="btn btn-primary" id="exportBtn" disabled>导出 ZIP</button>
      <a class="btn btn-outline" id="dlLink" style="display:none">下载</a>
    </div>
  </main>

  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.staticfile.org/pdf.js/3.11.174/pdf.worker.min.js';

    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const thumbs = document.getElementById('thumbs');
    const exportBtn = document.getElementById('exportBtn');
    const dlLink = document.getElementById('dlLink');

    drop.addEventListener('dragover', e => { e.preventDefault(); drop.style.background='#f8fafc'; });
    drop.addEventListener('dragleave', e => { e.preventDefault(); drop.style.background=''; });
    drop.addEventListener('drop', e => { e.preventDefault(); handleFiles(e.dataTransfer.files); drop.style.background=''; });
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    async function handleFiles(files){
      const file = files && files[0];
      if(!file) return;
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      thumbs.innerHTML = '';
      const images = [];
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        const dataUrl = canvas.toDataURL('image/png');
        images.push({ name: `page-${String(p).padStart(3,'0')}.png`, dataUrl });
        const img = new Image(); img.src = dataUrl; img.style.width='100%'; img.className='thumb';
        thumbs.appendChild(img);
      }
      exportBtn.disabled = false;
      exportBtn.onclick = () => exportZip(images);
    }

    async function exportZip(images){
      const files = images.map(x => x.name);
      const manifest = { basePath: 'manual-images', files };
      const zipParts = [];

      // Minimal zip via Blob: use separate downloads instead of zip dependency to keep page simple
      // 1) Offer manifest.json
      const manifestBlob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
      const manifestUrl = URL.createObjectURL(manifestBlob);
      const manifestA = document.createElement('a');
      manifestA.href = manifestUrl;
      manifestA.download = 'manifest.json';
      manifestA.textContent = '下载 manifest.json';

      // 2) Offer each image file
      const list = document.createElement('div');
      list.style.marginTop = '10px';
      list.appendChild(manifestA);
      list.appendChild(document.createElement('hr'));
      for(const it of images){
        const a = document.createElement('a');
        a.href = it.dataUrl;
        a.download = it.name;
        a.textContent = `下载 ${it.name}`;
        a.style.display = 'block';
        list.appendChild(a);
      }

      thumbs.appendChild(list);
      dlLink.style.display='none';
    }
  </script>
</body>
</html> 